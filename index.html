<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fruit Ninja Zen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; touch-action: none; user-select: none; font-family: 'Comic Sans MS', cursive, sans-serif; }
        canvas { display: block; }
        #bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: -1; }
        .ui { position: absolute; pointer-events: none; z-index: 10; color: white; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .btn { pointer-events: auto; cursor: pointer; background: linear-gradient(#34d399, #10b981); padding: 18px 50px; border-radius: 99px; font-weight: bold; font-size: 28px; border: none; color: white; box-shadow: 0 6px 0 #166534; transition: all 0.15s; }
        .btn:active { transform: translateY(4px); box-shadow: 0 2px 0 #166534; }
        .hidden { display: none !important; }
        .score-box { position: absolute; top: 20px; left: 20px; text-align: left; background: rgba(0,0,0,0.4); padding: 10px 20px; border-radius: 20px; backdrop-blur-sm; }
    </style>
</head>
<body class="bg-gradient-to-b from-sky-400 to-sky-600">
    <img id="bg" src="https://images.unsplash.com/photo-1580196969802-93c67c6df226?ixlib=rb-4.0.3&auto=format&fit=crop&w=2000&q=80" alt="sky background">
    
    <div id="menu" class="ui bg-black/50 backdrop-blur-md">
        <h1 class="text-7xl font-black text-yellow-300 mb-10 rotate-[-5deg] drop-shadow-2xl tracking-wider">FRUIT NINJA</h1>
        <p class="text-white mb-12 text-center px-8 text-xl">Режим Дзен: Режь фрукты, избегай бомб!<br>Пропущенные фрукты не штрафуют.</p>
        <button class="btn shadow-2xl" onclick="startGame()">ИГРАТЬ</button>
    </div>
    
    <div id="game-ui" class="ui hidden">
        <div class="score-box">
            <div class="text-4xl font-bold text-yellow-300 drop-shadow-lg">Счет: <span id="score">0</span></div>
            <div class="text-lg opacity-80">Рекорд: <span id="best">0</span></div>
        </div>
    </div>
    
    <div id="over" class="ui hidden bg-red-900/90 backdrop-blur-lg">
        <h2 class="text-7xl font-black text-white mb-6 drop-shadow-2xl">БУУУМ!</h2>
        <div class="bg-black/50 p-8 rounded-3xl mb-10 text-center min-w-[250px] shadow-2xl">
            <p class="text-gray-200 text-xl">Твой счет</p>
            <p class="text-7xl font-black text-yellow-300" id="final-score">0</p>
        </div>
        <button class="btn shadow-2xl" onclick="startGame()">ЕЩЕ РАЗ</button>
    </div>
    
    <canvas id="c"></canvas>

<audio id="music" loop>
    <source src="https://cdn.pixabay.com/download/audio/2022/08/15/audio_0d3b7f5c5a.mp3?filename=asian-epic-11856.mp3" type="audio/mpeg">
</audio>
<audio id="sliceSound">
    <source src="https://cdn.pixabay.com/download/audio/2023/06/20/audio_8f2e0b7e3d.mp3?filename=fruit-slice-103052.mp3" type="audio/mpeg">
</audio>
<audio id="bombSound">
    <source src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_57b3c8e8d9.mp3?filename=bomb-explosion-102879.mp3" type="audio/mpeg">
</audio>
<audio id="splashSound">
    <source src="https://cdn.pixabay.com/download/audio/2022/05/18/audio_4e5f2d8f8b.mp3?filename=water-splash-96428.mp3" type="audio/mpeg">
</audio>

<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let canvasW, canvasH, score = 0, best = localStorage.getItem('fn_best') || 0;
let isPlaying = false, fruits = [], particles = [], blade = [], frames = 0;

const music = document.getElementById('music');
const sliceSound = document.getElementById('sliceSound');
const bombSound = document.getElementById('bombSound');
const splashSound = document.getElementById('splashSound');

function resize() {
    canvasW = canvas.width = window.innerWidth;
    canvasH = canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

class Fruit {
    constructor() {
        this.reset();
    }
    reset() {
        this.x = Math.random() * (canvasW - 100) + 50;
        this.y = canvasH + 80;
        this.vx = (Math.random() - 0.5) * 6;
        this.vy = -(Math.random() * 8 + 12);
        this.r = 40;
        this.type = Math.random() < 0.18 ? 'bomb' : 'fruit';
        this.color = this.type === 'bomb' ? '#111' : `hsl(${Math.random() * 60 + 10}, 80%, 55%)`; // более фруктовые цвета
        this.angle = 0;
        this.rot = Math.random() * 0.15 - 0.075;
        this.sliced = false;
    }
    update() {
        this.x += this.vx;
        this.y += this.vy;
        this.vy += 0.15; // гравитация
        this.angle += this.rot;
    }
    draw() {
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.angle);
        ctx.shadowBlur = 15;
        ctx.shadowColor = 'rgba(0,0,0,0.5)';
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.arc(0, 0, this.r, 0, Math.PI * 2);
        ctx.fill();
        
        if(this.type === 'bomb') {
            ctx.fillStyle = '#f00';
            ctx.beginPath();
            ctx.arc(0, -10, 12, 0, Math.PI*2);
            ctx.fill();
            ctx.fillStyle = '#ff0';
            ctx.beginPath();
            ctx.arc(0, -10, 6 + Math.sin(frames*0.3)*3, 0, Math.PI*2);
            ctx.fill();
        }
        ctx.restore();
    }
}

class Half {
    constructor(f, side) {
        Object.assign(this, f);
        this.vx += side * 5;
        this.vy -= Math.random() * 5;
        this.side = side;
        this.life = 1;
    }
    update() {
        this.x += this.vx; this.y += this.vy; this.vy += 0.25; this.angle += this.rot * 3;
        this.life -= 0.015;
    }
    draw() {
        ctx.save();
        ctx.globalAlpha = this.life;
        ctx.translate(this.x, this.y);
        ctx.rotate(this.angle);
        ctx.fillStyle = this.color;
        ctx.beginPath();
        const angle = this.side === 1 ? Math.PI/2 : -Math.PI/2;
        ctx.arc(0, 0, this.r, angle - Math.PI/2, angle + Math.PI/2);
        ctx.lineTo(0,0);
        ctx.fill();
        ctx.restore();
    }
}

function startGame() {
    score = 0; fruits = []; particles = []; isPlaying = true;
    document.getElementById('menu').classList.add('hidden');
    document.getElementById('over').classList.add('hidden');
    document.getElementById('game-ui').classList.remove('hidden');
    document.getElementById('score').innerText = score;
    document.getElementById('best').innerText = best;
    
    music.currentTime = 0;
    music.play().catch(() => {});
    loop();
}

function playSound(sound) {
    sound.currentTime = 0;
    sound.play().catch(() => {});
}

function slice(f, i) {
    if(f.type === 'bomb') {
        isPlaying = false;
        playSound(bombSound);
        if(score > best) { best = score; localStorage.setItem('fn_best', best); document.getElementById('best').innerText = best; }
        document.getElementById('final-score').innerText = score;
        document.getElementById('over').classList.remove('hidden');
        music.pause();
        return;
    }
    score++;
    document.getElementById('score').innerText = score;
    playSound(sliceSound);
    playSound(splashSound);
    fruits.splice(i, 1);
    particles.push(new Half(f, 1), new Half(f, -1));
    
    for(let j=0; j<20; j++) {
        const p = {
            x: f.x, y: f.y,
            vx: (Math.random()-0.5)*15, vy: (Math.random()-0.8)*15,
            r: Math.random()*8 + 3, c: f.color, l: 1
        };
        p.update = function() { this.x += this.vx; this.y += this.vy; this.vy += 0.3; this.l -= 0.03; };
        p.draw = function() { 
            ctx.globalAlpha = this.l;
            ctx.fillStyle = this.c; 
            ctx.beginPath(); 
            ctx.arc(this.x, this.y, this.r, 0, Math.PI*2); 
            ctx.fill(); 
        };
        particles.push(p);
    }
}

function loop() {
    if(!isPlaying) return;
    frames++;
    ctx.clearRect(0, 0, canvasW, canvasH); // фон прозрачный, виден background
    
    if(frames % 55 === 0) fruits.push(new Fruit());
    
    for(let i = fruits.length-1; i>=0; i--) {
        let f = fruits[i];
        f.update(); f.draw();
        
        if(blade.length > 3) {
            for(let j=1; j<blade.length; j++) {
                const prev = blade[j-1];
                const curr = blade[j];
                const dx = curr.x - prev.x;
                const dy = curr.y - prev.y;
                const len = Math.hypot(dx, dy);
                if(len > 0) {
                    for(let k=0; k<len; k+=10) {
                        const px = prev.x + (dx/len)*k;
                        const py = prev.y + (dy/len)*k;
                        if(Math.hypot(f.x - px, f.y - py) < f.r + 10) {
                            slice(f, i);
                            break;
                        }
                    }
                }
            }
        }
        
        if(f.y > canvasH + 150) fruits.splice(i, 1);
    }
    
    for(let i = particles.length-1; i>=0; i--) {
        let p = particles[i];
        p.update(); p.draw();
        if(p.y > canvasH + 150 || p.l <= 0) particles.splice(i, 1);
    }
    
    // Красивый след меча
    if(blade.length > 1) {
        const grad = ctx.createLinearGradient(blade[0].x, blade[0].y, blade[blade.length-1].x, blade[blade.length-1].y);
        grad.addColorStop(0, 'rgba(0,255,255,0)');
        grad.addColorStop(0.5, 'rgba(0,255,255,0.8)');
        grad.addColorStop(1, 'rgba(0,255,255,0)');
        ctx.strokeStyle = grad;
        ctx.lineWidth = 8;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.shadowBlur = 20;
        ctx.shadowColor = '#0ff';
        ctx.beginPath();
        ctx.moveTo(blade[0].x, blade[0].y);
        for(let p of blade) ctx.lineTo(p.x, p.y);
        ctx.stroke();
    }
    
    requestAnimationFrame(loop);
}

// Улучшенная обработка ввода (мышь + тач)
let touching = false;
const inputHandler = (e) => {
    e.preventDefault();
    const touches = e.touches || [e];
    blade = [];
    touching = e.type !== 'mouseup' && e.type !== 'touchend';
    
    for(let touch of touches) {
        const x = touch.clientX || touch.pageX;
        const y = touch.clientY || touch.pageY;
        blade.push({x, y});
    }
};

window.addEventListener('mousedown', inputHandler);
window.addEventListener('mousemove', (e) => { if(touching) inputHandler(e); });
window.addEventListener('mouseup', inputHandler);

window.addEventListener('touchstart', inputHandler, {passive: false});
window.addEventListener('touchmove', inputHandler, {passive: false});
window.addEventListener('touchend', inputHandler, {passive: false});
</script>
</body>
</html>

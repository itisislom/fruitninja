<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fruit Ninja Zen Plus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background: radial-gradient(circle, #2c3e50 0%, #000000 100%); 
            touch-action: none; 
            user-select: none; 
            font-family: 'Segoe UI', Roboto, sans-serif; 
        }
        canvas { display: block; }
        .ui { 
            position: absolute; 
            pointer-events: none; 
            z-index: 10; 
            color: white; 
            width: 100%; 
            height: 100%; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            transition: opacity 0.3s;
        }
        .btn { 
            pointer-events: auto; 
            cursor: pointer; 
            background: linear-gradient(to bottom, #4ade80, #16a34a); 
            padding: 18px 50px; 
            border-radius: 99px; 
            font-weight: 900; 
            font-size: 28px; 
            border: 3px solid #bbf7d0; 
            color: white; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.3), inset 0 -4px 0 rgba(0,0,0,0.2); 
            transition: all 0.1s;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .btn:active { transform: scale(0.95); box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .hidden { opacity: 0; pointer-events: none; }
        .score-box { 
            position: absolute; 
            top: 20px; 
            left: 20px; 
            text-align: left; 
            background: rgba(0,0,0,0.3);
            padding: 10px 20px;
            border-radius: 15px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .shake-effect { animation: shake 0.5s; }
    </style>
</head>
<body>

    <div id="menu" class="ui bg-black/40 backdrop-blur-md">
        <h1 class="text-7xl font-black text-yellow-400 mb-2 rotate-[-2deg] drop-shadow-[0_5px_15px_rgba(250,204,21,0.4)] uppercase">Ninja</h1>
        <h2 class="text-4xl font-black text-white mb-8 tracking-[10px] uppercase">Zen Plus</h2>
        <p class="text-white/80 mb-10 text-center px-6 max-w-md italic">Режь фрукты, избегай бомб. <br>Чистое искусство меча.</p>
        <button id="playBtn" class="btn">Играть</button>
    </div>

    <div id="game-ui" class="ui hidden">
        <div class="score-box">
            <div class="text-sm uppercase tracking-widest text-white/60">Счет</div>
            <div class="text-4xl font-black text-yellow-400"><span id="score">0</span></div>
            <div class="text-xs mt-1 opacity-50">Рекорд: <span id="best">0</span></div>
        </div>
    </div>

    <div id="over" class="ui hidden bg-red-950/90 backdrop-blur-xl">
        <h2 class="text-7xl font-black text-white mb-6 uppercase italic">Бум!</h2>
        <div class="bg-white/10 p-8 rounded-3xl mb-10 text-center border border-white/10 shadow-2xl">
            <p class="text-white/60 text-sm tracking-widest uppercase mb-2">Результат</p>
            <p class="text-7xl font-black text-yellow-400" id="final-score">0</p>
        </div>
        <button id="restartBtn" class="btn">Заново</button>
    </div>

    <canvas id="c"></canvas>

<script>
/**
 * Звуковой движок (Web Audio API)
 */
const AudioEngine = {
    ctx: null,
    masterGain: null,
    init() {
        if (this.ctx) return;
        this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        this.masterGain = this.ctx.createGain();
        this.masterGain.connect(this.ctx.destination);
    },
    playTone(freq, type, duration, vol) {
        if (!this.ctx) return;
        const osc = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        g.gain.setValueAtTime(vol, this.ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + duration);
        osc.connect(g);
        g.connect(this.masterGain);
        osc.start();
        osc.stop(this.ctx.currentTime + duration);
    },
    playSlice() {
        this.playTone(400 + Math.random() * 400, 'triangle', 0.2, 0.1);
    },
    playBoom() {
        this.playTone(100, 'sawtooth', 1.0, 0.3);
        this.playTone(50, 'sine', 1.5, 0.5);
    },
    playAmbient() {
        const osc = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        osc.frequency.setValueAtTime(110, this.ctx.currentTime);
        g.gain.setValueAtTime(0.02, this.ctx.currentTime);
        osc.connect(g);
        g.connect(this.masterGain);
        osc.start();
    }
};

const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
let canvasW, canvasH, score = 0, best = localStorage.getItem('fn_best_plus') || 0;
let isPlaying = false, fruits = [], particles = [], blade = [], frames = 0;

function resize() {
    canvasW = canvas.width = window.innerWidth;
    canvasH = canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

class Fruit {
    constructor() {
        this.reset();
    }
    reset() {
        this.x = Math.random() * (canvasW - 100) + 50;
        this.y = canvasH + 50;
        this.vx = (Math.random() - 0.5) * 6;
        this.vy = -(Math.random() * 5 + 12);
        this.r = 38;
        this.type = Math.random() < 0.15 ? 'bomb' : 'fruit';
        this.color = this.type === 'bomb' ? '#1a1a1a' : `hsl(${Math.random() * 360}, 80%, 50%)`;
        this.angle = 0;
        this.rot = Math.random() * 0.1 - 0.05;
    }
    update() {
        this.x += this.vx;
        this.y += this.vy;
        this.vy += 0.15;
        this.angle += this.rot;
    }
    draw() {
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.angle);
        
        // Тень
        ctx.shadowBlur = 15;
        ctx.shadowColor = 'rgba(0,0,0,0.5)';
        
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.arc(0, 0, this.r, 0, Math.PI * 2);
        ctx.fill();
        
        if(this.type === 'bomb') {
            ctx.fillStyle = '#ff0000';
            ctx.beginPath();
            ctx.arc(0, 0, 12 + Math.sin(frames*0.3)*4, 0, Math.PI * 2);
            ctx.fill();
            // Фитиль
            ctx.strokeStyle = '#555';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(0, -this.r);
            ctx.quadraticCurveTo(10, -this.r-10, 5, -this.r-20);
            ctx.stroke();
        } else {
            // Блик
            ctx.fillStyle = 'rgba(255,255,255,0.3)';
            ctx.beginPath();
            ctx.arc(-this.r/3, -this.r/3, this.r/4, 0, Math.PI*2);
            ctx.fill();
        }
        ctx.restore();
    }
}

class Half {
    constructor(f, side) {
        Object.assign(this, f);
        this.vx += side * 4;
        this.vy -= 2;
        this.side = side;
        this.life = 1;
    }
    update() {
        this.x += this.vx; this.y += this.vy; this.vy += 0.25; this.angle += this.rot * 3;
        this.life -= 0.015;
    }
    draw() {
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.angle);
        ctx.globalAlpha = this.life;
        ctx.fillStyle = this.color;
        ctx.beginPath();
        // Рисуем половинку
        if (this.side === 1) ctx.arc(0, 0, this.r, -Math.PI/2, Math.PI/2);
        else ctx.arc(0, 0, this.r, Math.PI/2, -Math.PI/2);
        ctx.fill();
        
        // Внутренняя часть
        ctx.fillStyle = 'rgba(255,255,255,0.2)';
        ctx.fillRect(this.side === 1 ? -2 : -2, -this.r, 4, this.r*2);
        
        ctx.restore();
    }
}

function startGame() {
    AudioEngine.init();
    AudioEngine.playAmbient();
    
    score = 0; fruits = []; particles = []; isPlaying = true;
    document.getElementById('menu').classList.add('hidden');
    document.getElementById('over').classList.add('hidden');
    document.getElementById('game-ui').classList.remove('hidden');
    document.getElementById('score').innerText = score;
    document.getElementById('best').innerText = best;
    loop();
}

function slice(f, i) {
    if(f.type === 'bomb') {
        isPlaying = false;
        AudioEngine.playBoom();
        document.body.classList.add('shake-effect');
        setTimeout(() => document.body.classList.remove('shake-effect'), 500);
        
        if(score > best) { best = score; localStorage.setItem('fn_best_plus', best); }
        document.getElementById('final-score').innerText = score;
        document.getElementById('over').classList.remove('hidden');
        return;
    }
    
    score++;
    AudioEngine.playSlice();
    document.getElementById('score').innerText = score;
    fruits.splice(i, 1);
    
    // Половинки
    particles.push(new Half(f, 1), new Half(f, -1));
    
    // Брызги сока
    for(let j=0; j<15; j++) {
        particles.push({
            x: f.x, y: f.y, 
            vx: (Math.random()-0.5)*12, 
            vy: (Math.random()-0.5)*12,
            r: Math.random()*6 + 2, 
            c: f.color, 
            l: 1,
            update() { this.x += this.vx; this.y += this.vy; this.vy += 0.2; this.l -= 0.02; },
            draw() { 
                ctx.globalAlpha = this.l; 
                ctx.fillStyle = this.c; 
                ctx.beginPath(); 
                ctx.arc(this.x, this.y, this.r, 0, Math.PI*2); 
                ctx.fill(); 
                ctx.globalAlpha = 1; 
            }
        });
    }
}

function loop() {
    if(!isPlaying) return;
    frames++;
    
    // Очистка с легким шлейфом
    ctx.fillStyle = 'rgba(20, 30, 48, 0.4)';
    ctx.fillRect(0, 0, canvasW, canvasH);

    // Частота появления фруктов увеличивается со временем
    let spawnRate = Math.max(20, 60 - Math.floor(score / 5));
    if(frames % spawnRate === 0) fruits.push(new Fruit());

    // Обновление фруктов
    for(let i = fruits.length-1; i>=0; i--) {
        let f = fruits[i];
        f.update(); f.draw();
        
        if(blade.length > 1) {
            for(let j=0; j<blade.length-1; j++) {
                let d = Math.hypot(f.x - blade[j].x, f.y - blade[j].y);
                if(d < f.r + 5) { slice(f, i); break; }
            }
        }
        if(f.y > canvasH + 100) fruits.splice(i, 1);
    }

    // Обновление эффектов
    for(let i = particles.length-1; i>=0; i--) {
        let p = particles[i];
        p.update(); p.draw();
        if(p.y > canvasH + 100 || (p.l !== undefined && p.l <= 0) || (p.life !== undefined && p.life <= 0)) {
            particles.splice(i, 1);
        }
    }

    // Отрисовка лезвия
    if(blade.length > 1) {
        ctx.shadowBlur = 15;
        ctx.shadowColor = '#0ff';
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 6;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.beginPath(); 
        ctx.moveTo(blade[0].x, blade[0].y);
        for(let k=1; k<blade.length; k++) {
            ctx.lineTo(blade[k].x, blade[k].y);
        }
        ctx.stroke();
        ctx.shadowBlur = 0;
    }
    
    requestAnimationFrame(loop);
}

// Универсальный ввод для мобилок и ПК
const handleInput = (e) => {
    // Останавливаем стандартное поведение, чтобы не дергался экран
    if (e.cancelable) e.preventDefault();
    
    const rect = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    
    const x = clientX - rect.left;
    const y = clientY - rect.top;

    if(e.type.includes('start') || e.type.includes('down')) {
        blade = [];
    }
    
    // Проверяем нажата ли кнопка (для мыши) или идет ли касание
    if(isPlaying && (e.buttons > 0 || e.type.includes('touch'))) {
        blade.push({x, y});
        if(blade.length > 12) blade.shift();
    } else {
        blade = [];
    }
};

// Исправлено: используем pointerdown для кнопок, чтобы срабатывало везде
document.getElementById('playBtn').addEventListener('pointerdown', (e) => {
    e.stopPropagation();
    startGame();
});

document.getElementById('restartBtn').addEventListener('pointerdown', (e) => {
    e.stopPropagation();
    startGame();
});

// События для игры
['mousedown', 'mousemove', 'mouseup', 'touchstart', 'touchmove', 'touchend'].forEach(evt => {
    window.addEventListener(evt, handleInput, {passive: false});
});

</script>
</body>
</html>

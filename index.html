<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fruit Ninja Zen</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; overflow: hidden; background: #1a1a1a; touch-action: none; user-select: none; font-family: sans-serif; }
        canvas { display: block; }
        .ui { position: absolute; pointer-events: none; z-index: 10; color: white; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .btn { pointer-events: auto; cursor: pointer; background: #22c55e; padding: 15px 40px; border-radius: 99px; font-weight: bold; font-size: 24px; border: none; color: white; box-shadow: 0 4px 0 #166534; transition: 0.1s; }
        .btn:active { transform: translateY(3px); box-shadow: none; }
        .hidden { display: none !important; }
        .score-box { position: absolute; top: 20px; left: 20px; text-align: left; }
    </style>
</head>
<body>

    <div id="menu" class="ui bg-black/60 backdrop-blur-sm">
        <h1 class="text-6xl font-black text-yellow-500 mb-8 rotate-[-3deg] drop-shadow-2xl">FRUIT NINJA</h1>
        <p class="text-white mb-8 text-center px-6">Режим Дзен: Режь всё, кроме бомб!<br>Пропуски не считаются.</p>
        <button class="btn" onclick="startGame()">ИГРАТЬ</button>
    </div>

    <div id="game-ui" class="ui hidden">
        <div class="score-box">
            <div class="text-3xl font-bold text-yellow-400">Счет: <span id="score">0</span></div>
            <div class="text-sm opacity-70">Рекорд: <span id="best">0</span></div>
        </div>
    </div>

    <div id="over" class="ui hidden bg-red-900/80 backdrop-blur-md">
        <h2 class="text-6xl font-black text-white mb-4">БУУУМ!</h2>
        <div class="bg-black/40 p-6 rounded-2xl mb-8 text-center min-w-[200px]">
            <p class="text-gray-300">ТВОЙ СЧЕТ</p>
            <p class="text-6xl font-black text-yellow-400" id="final-score">0</p>
        </div>
        <button class="btn" onclick="startGame()">ЕЩЕ РАЗ</button>
    </div>

    <canvas id="c"></canvas>

<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
// Переименованы w и h для избежания конфликтов имен
let canvasW, canvasH, score = 0, best = localStorage.getItem('fn_best') || 0;
let isPlaying = false, fruits = [], particles = [], blade = [], frames = 0;

function resize() {
    canvasW = canvas.width = window.innerWidth;
    canvasH = canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

class Fruit {
    constructor() {
        this.reset();
    }
    reset() {
        this.x = Math.random() * (canvasW - 100) + 50;
        this.y = canvasH + 50;
        this.vx = (Math.random() - 0.5) * 4;
        this.vy = -(Math.random() * 5 + 10);
        this.r = 35;
        this.type = Math.random() < 0.2 ? 'bomb' : 'fruit';
        this.color = this.type === 'bomb' ? '#222' : `hsl(${Math.random() * 360}, 70%, 50%)`;
        this.angle = 0;
        this.rot = Math.random() * 0.1 - 0.05;
        this.sliced = false;
    }
    update() {
        this.x += this.vx;
        this.y += this.vy;
        this.vy += 0.1;
        this.angle += this.rot;
    }
    draw() {
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.angle);
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.arc(0, 0, this.r, 0, Math.PI * 2);
        ctx.fill();
        if(this.type === 'bomb') {
            ctx.fillStyle = 'red';
            ctx.beginPath();
            ctx.arc(0, 0, 10 + Math.sin(frames*0.2)*5, 0, Math.PI*2);
            ctx.fill();
        }
        ctx.restore();
    }
}

class Half {
    constructor(f, side) {
        Object.assign(this, f);
        this.vx += side * 3;
        this.side = side;
        this.life = 1;
    }
    update() {
        this.x += this.vx; this.y += this.vy; this.vy += 0.2; this.angle += this.rot * 2;
        this.life -= 0.01;
    }
    draw() {
        ctx.save();
        ctx.translate(this.x, this.y);
        ctx.rotate(this.angle);
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.arc(0, 0, this.r, this.side === 1 ? -Math.PI/2 : Math.PI/2, this.side === 1 ? Math.PI/2 : -Math.PI/2);
        ctx.fill();
        ctx.restore();
    }
}

function startGame() {
    score = 0; fruits = []; particles = []; isPlaying = true;
    document.getElementById('menu').classList.add('hidden');
    document.getElementById('over').classList.add('hidden');
    document.getElementById('game-ui').classList.remove('hidden');
    document.getElementById('score').innerText = score;
    document.getElementById('best').innerText = best;
    loop();
}

function slice(f, i) {
    if(f.type === 'bomb') {
        isPlaying = false;
        if(score > best) { best = score; localStorage.setItem('fn_best', best); }
        document.getElementById('final-score').innerText = score;
        document.getElementById('over').classList.remove('hidden');
        return;
    }
    score++;
    document.getElementById('score').innerText = score;
    fruits.splice(i, 1);
    particles.push(new Half(f, 1), new Half(f, -1));
    for(let j=0; j<10; j++) {
        particles.push({
            x: f.x, y: f.y, vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
            r: Math.random()*5, c: f.color, l: 1,
            update() { this.x += this.vx; this.y += this.vy; this.vy += 0.2; this.l -= 0.02; },
            draw() { ctx.globalAlpha = this.l; ctx.fillStyle = this.c; ctx.beginPath(); ctx.arc(this.x, this.y, this.r, 0, Math.PI*2); ctx.fill(); ctx.globalAlpha = 1; }
        });
    }
}

function loop() {
    if(!isPlaying) return;
    frames++;
    ctx.fillStyle = '#1a1a1a';
    ctx.fillRect(0, 0, canvasW, canvasH);

    if(frames % 60 === 0) fruits.push(new Fruit());

    for(let i = fruits.length-1; i>=0; i--) {
        let f = fruits[i];
        f.update(); f.draw();
        if(blade.length > 1) {
            for(let j=0; j<blade.length-1; j++) {
                let d = Math.hypot(f.x - blade[j].x, f.y - blade[j].y);
                if(d < f.r) { slice(f, i); break; }
            }
        }
        if(f.y > canvasH + 100) fruits.splice(i, 1);
    }

    for(let i = particles.length-1; i>=0; i--) {
        let p = particles[i];
        p.update(); p.draw();
        if(p.y > canvasH + 100 || (p.l && p.l <= 0)) particles.splice(i, 1);
    }

    if(blade.length > 1) {
        ctx.strokeStyle = '#0ff'; ctx.lineWidth = 5; ctx.lineCap = 'round';
        ctx.beginPath(); ctx.moveTo(blade[0].x, blade[0].y);
        blade.forEach(p => ctx.lineTo(p.x, p.y));
        ctx.stroke();
    }
    requestAnimationFrame(loop);
}

const input = (e) => {
    const x = e.touches ? e.touches[0].clientX : e.clientX;
    const y = e.touches ? e.touches[0].clientY : e.clientY;
    if(e.type.includes('start')) blade = [];
    if(isPlaying && (e.buttons > 0 || e.type.includes('touch'))) {
        blade.push({x, y});
        if(blade.length > 10) blade.shift();
    } else {
        blade = [];
    }
};

['mousedown', 'mousemove', 'mouseup', 'touchstart', 'touchmove', 'touchend'].forEach(evt => {
    window.addEventListener(evt, (e) => { if(evt.includes('touch')) e.preventDefault(); input(e); }, {passive: false});
});
</script>
</body>
</html>